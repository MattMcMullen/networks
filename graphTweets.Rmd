---
title: "graphTweets"
output: html_notebook
---


```{r}
library(tidyverse)
library(DT)
library(igraph)
library(rtweet)
library(visNetwork)
library(graphTweets)            # This package turns twitter data into edge & node data

```


edges based on mentions, retweets, or hashtags 
billings area, several individuals' timelines: obama/trump, montana politicans, gazette reporters, psychology tweeters



Twitter is a social network that can be mapped and analyzed with igraph in R. It is possible to simply use rtweet to download tweets, and then orgranize the data to create a network, but it's time-consuming to organize the data into nodes and edges appropriate for network analysis. Instead, we can use a package called graphTweets to do the dirty work for us.

Let's start with an example where we collect tweets with the hastag #MeToo.


1. Collect tweets. You can use search_tweets() or get_timeline().
2. Create the network with graphTweet's gt_edges() and gt_graph()
3. Get the nodes and edges with as_data_frame().

Then we can use visNetwork to create the graph with the node and edge data, as well as generate some statistics with network in igraph.


Step 1: Collect tweets.

```{r}
metoo_tweets <- search_tweets("#MeToo", n = 500, include_rts = FALSE)
```

You may want to look at the data again by clicking on 'metoo_tweets' in the Global Environment pane to familiarize yourself with the data that rtweet provides.

There are a few ways that people might be connected in twitter. We'll focus on mentions, retweets, and hashtags. 

Let's start with mentions: When one user mentions another user in a tweet, that's a connection.

To use graphTweets, you need to get the edges of the network with gt_edges(), and provide the screen_name (the person) and then their mentions. To do that, use mentions_screen_name(), which will get other people that the first person mentioned. For example, if I'm @matt, and I tweet "@john Hi how are you," that's two nodes with one edge between them.

The following will take our metoo_tweets, grab the edges, and create an igraph network of mentions that we're calling metoo_graph. Then it shows a part of the network.







```{r}
metoo_graph <- metoo_tweets %>% 
  gt_edges(screen_name, mentions_screen_name, text) %>% 
  gt_graph()

metoo_graph

```





We want to get the edges and nodes from the network.

In the previous exercise introducing network analysis, we started with edges and nodes and then created the network. Now, we're going to go in the opposite direction: We will extract the nodes and edges from the network. We use as_data_frame() to do this.

Let's get both the edges and the nodes from the network. Remember that igraph calls nodes "vertices".

1. extract the nodes. It will have a 'name' column    
2. add new columns for id, label, and title, all with the name in them, because those are used by visNetwork

```{r}
metoo_nodes <- as_data_frame(metoo_graph, what = "vertices")

metoo_nodes <- metoo_nodes %>% 
  mutate(id = name) %>% 
  mutate(label = name) %>% 
  mutate(title = name)

metoo_nodes %>% 
  datatable()

```

Getting edges is simpler: Just use as_data_frame(), specify the network, and set what = "edges".

```{r}
metoo_edges <- as_data_frame(metoo_graph, what = "edges")

metoo_edges
```


This is a directed - or one-way - network, because one person is mentioning another, and it's not necessarily mutual. So we can add arrows to the edges.
```{r}
visNetwork(metoo_nodes, metoo_edges, main = "Network of #MeToo Tweets and Mentions") %>% 
  visEdges(arrows = "to")
```


Add degree to the nodes as we did previously.

```{r}
metoo_nodes <- metoo_nodes %>% 
  mutate(degree = degree(metoo_graph)) %>% 
  mutate(value = degree)

metoo_nodes %>% 
  datatable()
```



```{r}
visNetwork(metoo_nodes, metoo_edges, main = "Network of #MeToo Tweets and Mentions") %>% 
  visEdges(arrows = "to")
```








```{r}
tweets %>% 
  gt_edges(screen_name, mentions_screen_name, created_at) %>%    #created_at is not necessary, but just adds info 
  gt_collect() -> edges

edges



```











```{r}

tweets <- search_tweets("#MeToo", n = 1000, include_rts = FALSE, lang = "en")
```



```{r}
net <- tweets %>% 
  gt_edges(screen_name, hashtags) %>% 
  gt_nodes() %>% 
  gt_collect()


tweets %>% 
  gt_edges(screen_name, mentions_screen_name) %>% 
  gt_graph() -> net

net

```






```{r}
V(net)
E(net)
```



Rather than getting the network of mentions, we could get a network of retweets.

This gets a network of retweets.
```{r}
metoo_retweets <- search_tweets("#MeToo filter:retweets", n = 500, include_rts = TRUE, lang = "en")

```

Let's create the network and extract the nodes and edges as above.


```{r}
metoo_retweets %>% 
  gt_edges(screen_name, retweet_screen_name, text) %>% 
  gt_graph() -> metoo_retweet_network

metoo_retweet_nodes <- as_data_frame(metoo_retweet_network, what = "vertices")

metoo_retweet_nodes <- metoo_retweet_nodes %>% 
  mutate(id = name) %>% 
  mutate(label = name) %>% 
  mutate(title = name) %>% 
  mutate(degree = degree(metoo_retweet_network)) %>% 
  mutate(value = degree)

metoo_retweet_nodes %>% 
  datatable()


metoo_retweet_edges <- as_data_frame(metoo_retweet_network, what = "edges")

metoo_retweet_edges %>% 
  datatable()
```




```{r}
visNetwork(metoo_retweet_nodes, metoo_retweet_edges, main = "Retweets with #MeToo") %>% 
  visEdges(arrows = "to")
```






Tweets near Billings

```{r}
bl_tweets <- search_tweets(geocode = "45.80,-108.55,20mi", n = 500)

```

network of mentions

```{r}
bl_tweets %>% 
  gt_edges(screen_name, mentions_screen_name, text) %>% 
  gt_graph() -> bl_tweets_network

bl_tweets_nodes <- as_data_frame(bl_tweets_network, what = "vertices")

bl_tweets_nodes <- bl_tweets_nodes %>% 
  mutate(id = name) %>% 
  mutate(label = name) %>% 
  mutate(title = name) %>% 
  mutate(degree = degree(bl_tweets_network)) %>% 
  mutate(value = degree)

bl_tweets_nodes %>% 
  datatable()


bl_tweets_edges <- as_data_frame(bl_tweets_network, what = "edges")

bl_tweets_edges %>% 
  datatable()
```


```{r}
visNetwork(bl_tweets_nodes, bl_tweets_edges, main = "Tweets around Billings") %>% 
  visEdges(arrows = "to")
  
  
```





You also might look at a few individuals' tweets and get the network surrounding them.

Some prolific Psychology tweeters that I got from a list:
Susan K. Whitbourne
https://twitter.com/swhitbo

Art Markman
http://twitter.com/abmarkman

Professor Bob: Psychology and Ethics Professor
https://twitter.com/psychoBOBlogy

Heidi Reeder
https://twitter.com/heidireeder

Vaughan Bell
https://twitter.com/vaughanbell



```{r}
psych_tweeters <- c("swhitbo", "abmarkman", "psychoBOBlogy", "heidireeder", "vaughanbell")

```


We use get_timelines() to get the tweets of these individuals. We can just use the variable name psych_tweeters and it will get their tweets, up to the n that we provide.

```{r}
psych_tweets <- get_timelines(psych_tweeters, n = 1000)

```


Now convert it to a network, and then get the nodes and edges as we've done before. 
But let's do something a little different: Let's look at the hashtags they use, rather than mentions or retweets. If they use any of the same hashtags, they'll be linked in the network.

```{r}
psych_tweets %>% 
  gt_edges(screen_name, hashtags, text) %>% 
  gt_graph() -> psych_tweets_network

psych_tweets_nodes <- as_data_frame(psych_tweets_network, what = "vertices")

psych_tweets_nodes <- psych_tweets_nodes %>% 
  mutate(id = name) %>% 
  mutate(label = name) %>% 
  mutate(title = name) %>% 
  mutate(degree = degree(psych_tweets_network)) %>% 
  mutate(value = degree)

psych_tweets_nodes %>% 
  datatable()


psych_tweets_edges <- as_data_frame(psych_tweets_network, what = "edges")

psych_tweets_edges %>% 
  datatable()
```



```{r}
visNetwork(psych_tweets_nodes, psych_tweets_edges, main = "Psychology Retweets") %>% 
  visEdges(arrows = "to") %>% 
  visOptions(highlightNearest = T) %>% 
  visIgraphLayout() 
```








```{r}
obama_tweets <- get_timeline("BarackObama", n = 1000)
```

Now make the igraph object, looking at who he mentions in his tweets:


```{r}
obama_trump_tweets %>% 
  gt_edges(screen_name, hashtags) %>% 
  gt_graph() -> obama_net
```



```{r}
visIgraph(obama_net)
```






```{r}
clinton_trump_tweets <- get_timeline(c("realDonaldTrump", "HillaryClinton"), n = 1000)

```



Billings Gazette reporters

@ferg_mike, @__matt_______, @samalwilson, @BGKord, @BGmhoffman, @DarrellEhrlick, @BGMayer, @bgSueOlp


```{r}
bg_reporters <- c("ferg_mike", "__matt_______", "samalwilson", "BGKord", "BGmhoffman", "DarrellEhrlick", "BGMayer", "bgSueOlp")

bg_tweets <- get_timeline(bg_reporters, n = 500)
```


Look at their mentions.
```{r}
bg_tweets %>% 
  gt_edges(screen_name, mentions_screen_name) %>% 
  gt_graph() -> bg_mentions_net
```



```{r}
visIgraph(bg_mentions_net)
```





Look at the hastags they use.
```{r}
bg_tweets %>% 
  gt_edges(screen_name, hashtags) %>% 
  gt_graph() -> bg_hastags_net
```



```{r}
visIgraph(bg_hastags_net)
```








Assignment
Twitter names of Montana politicians